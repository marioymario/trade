services:
  # Tooling container: Jupyter + one-off commands via `docker compose run --rm trade ...`
  trade:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: trade
    container_name: trade
    ports:
      - "${JUPYTER_BIND_ADDR:-127.0.0.1}:8888:8888"
    env_file:
      - .env
    environment:
      SYMBOL: ${SYMBOL:-BTC/USD}
      TIMEFRAME: ${TIMEFRAME:-5m}
      CCXT_EXCHANGE: ${CCXT_EXCHANGE:-coinbase}
      DATA_TAG: ${DATA_TAG:-coinbase_live}
      DRY_RUN: ${DRY_RUN:-1}
      LOOP_SLEEP_SECONDS: ${LOOP_SLEEP_SECONDS:-60}
      MIN_BARS: ${MIN_BARS:-200}
      MAX_ORDER_SIZE: ${MAX_ORDER_SIZE:-0.01}
      FEE_BPS: ${FEE_BPS:-8}
      SLIPPAGE_BPS: ${SLIPPAGE_BPS:-5}
      COOLDOWN_BARS: ${COOLDOWN_BARS:-1}
      TF_ENABLE_ONEDNN_OPTS: 0
      TF_CPP_MIN_LOG_LEVEL: 2
      TZ: America/Los_Angeles
    # Run as host user to avoid root-owned bind-mount outputs
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./notebooks:/work/notebooks
      - ./files:/work/files
      - ./data:/work/data
      - /home/kk7wus/trade_flags:/home/kk7wus/trade_flags
    working_dir: /work
    command: >
      jupyter lab --ip=0.0.0.0 --no-browser
      --NotebookApp.token=''
      --NotebookApp.password=''

  # LIVE loop container: long-running `python -m files.main`
  paper:
    image: trade
    depends_on:
      - trade
    container_name: paper
    env_file:
      - .env
    environment:
      SYMBOL: ${SYMBOL:-BTC/USD}
      TIMEFRAME: ${TIMEFRAME:-5m}
      CCXT_EXCHANGE: ${CCXT_EXCHANGE:-coinbase}
      DATA_TAG: ${DATA_TAG:-coinbase_live}
      DRY_RUN: ${DRY_RUN:-1}
      LOOP_SLEEP_SECONDS: ${LOOP_SLEEP_SECONDS:-60}
      MIN_BARS: ${MIN_BARS:-200}
      MAX_ORDER_SIZE: ${MAX_ORDER_SIZE:-0.01}
      FEE_BPS: ${FEE_BPS:-8}
      SLIPPAGE_BPS: ${SLIPPAGE_BPS:-5}
      COOLDOWN_BARS: ${COOLDOWN_BARS:-1}
      TF_ENABLE_ONEDNN_OPTS: 0
      TF_CPP_MIN_LOG_LEVEL: 2
      TZ: America/Los_Angeles
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./files:/work/files
      - ./data:/work/data
      - /home/kk7wus/trade_flags:/home/kk7wus/trade_flags
    working_dir: /work
    command: python -m files.main

